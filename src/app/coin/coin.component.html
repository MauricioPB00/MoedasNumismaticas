<div class="coin-detail" *ngIf="coin">
  <!-- Título e meta -->
  <h2 class="coin-title">
    {{ coin.title || ('Moeda #' + (coin.id || '')) }}
    <small class="meta">
      <span *ngIf="coin.issuer">
        <img *ngIf="coin.showBrazilFlag" src="assets/img/bandeira-Brasil.png" class="flag" alt="Brasil">
        {{ coin.issuer.name }}
      </span>
      <span *ngIf="coin.category"> • {{ coin.categoryDisplay || coin.category }}</span>
      <span *ngIf="coin.minYear || coin.maxYear"> • {{ coin.minYear || '??' }} - {{ coin.maxYear || '??' }}</span>
    </small>
  </h2>
  <div class="coin-layout">
    <!-- Coluna esquerda: imagens e descrições -->
    <div class="coin-images">
      <!-- Linha de imagens -->
      <div class="coin-img-row">
        <img *ngIf="coin.obverseImg || coin.obverse" [src]="'assets/img/imagens/' + (coin.obverseImg || coin.obverse)"
          alt="Anverso" class="coin-img">
        <img *ngIf="coin.reverseImg || coin.reverse" [src]="'assets/img/imagens/' + (coin.reverseImg || coin.reverse)"
          alt="Reverso" class="coin-img">
        <img *ngIf="coin.edgeImg || coin.edge?.picture" [src]="'assets/img/imagens/' + coin.edgeImg"
          [alt]="coin.title || 'Moeda Borda'" class="coin-edge-img" (error)="removeEdgeImg()">
      </div>
      <!-- Descrições resumidas -->
      <div class="img-descriptions">
        <p *ngIf="coin.obverseDescription"><strong>Anverso:</strong> {{ coin.obverseDescription }}</p>
        <p *ngIf="coin.reverseDescription"><strong>Reverso:</strong> {{ coin.reverseDescription }}</p>
      </div>
      <!-- Detalhes das faces e borda -->
      <div class="more-info">
        <ng-container *ngFor="let side of ['reverse', 'obverse', 'edge']">
          <ng-container *ngIf="coin[side]">
            <h3>{{ side | titlecase }}</h3>
            <p *ngIf="coin[side].description">
              <strong>Descrição ({{ side | titlecase }}):</strong> {{ coin[side].description }}
            </p>
            <p *ngIf="coin[side].lettering">
              <strong>Letreiro ({{ side | titlecase }}):</strong> {{ coin[side].lettering }}
            </p>
            <p *ngIf="coin[side].lettering_scripts?.length">
              <strong>Scripts do letreiro ({{ side | titlecase }}):</strong>
              <span *ngFor="let script of coin[side].lettering_scripts; let last = last">
                {{ script.name }}<span *ngIf="!last">, </span>
              </span>
            </p>
          </ng-container>
        </ng-container>
        <div *ngIf="coin">
          <h2>{{ coin.title || ('Moeda #' + (coin.id || '')) }}</h2>
          <!-- infos gerais -->
          <div class="more-info">
            <ng-container *ngFor="let side of ['reverse', 'obverse']">
              <h3>{{ side | titlecase }}</h3>
              <div *ngIf="coin[side]">
                <p *ngIf="coin[side].description"><strong>Descrição:</strong> {{ coin[side].description }}</p>
                <p *ngIf="coin[side].lettering"><strong>Letreiro:</strong> {{ coin[side].lettering }}</p>
              </div>
            </ng-container>
          </div>
          <!-- adicionar ao álbum -->
          <div *ngIf="coinEntries.length > 0; else noYears" class="album-form">
            <h3>Adicionar ao Álbum</h3>
            <table>
              <thead>
                <tr>
                  <th>Ano</th>
                  <th>Quantidade</th>
                  <th>Estado</th>
                  <th>Ação</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let entry of coinEntries">
                  <td>{{ entry.year }}</td>
                  <td>
                    <input type="number" [(ngModel)]="entry.quantity" min="0" [ngModelOptions]="{standalone: true}"
                      placeholder="0">
                  </td>
                  <td>
                    <select [(ngModel)]="entry.condition" [ngModelOptions]="{standalone: true}">
                      <option [ngValue]="null">--</option>
                      <option value="FC">FC</option>
                      <option value="S">S</option>
                      <option value="MBC">MBC</option>
                      <option value="BC">BC</option>
                      <option value="R">R</option>
                      <option value="UTG">UTG</option>
                    </select>
                  </td>
                  <td>
                    <button (click)="saveEntry(entry)">Salvar</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noYears>
            <p><em>Nenhum ano disponível para esta moeda</em></p>
          </ng-template>
        </div>
      </div>
    </div>
    <!-- Coluna direita: dados detalhados -->
    <div class="coin-info">
      <!-- Dados principais -->
      <section class="section">
        <h3>Dados principais</h3>
        <p *ngIf="formatValue(coin)"><strong>Valor:</strong> {{ formatValue(coin) }}</p>
        <p *ngIf="coin.type"><strong>Tipo:</strong> {{ coin.type }}</p>
        <p *ngIf="coin.ruler?.length"><strong>Governante:</strong>
          <span *ngFor="let r of coin.ruler; let last = last"> {{ r.name }}<span *ngIf="!last">, </span></span>
        </p>
        <p *ngIf="coin.ruler?.length"><strong>Grupo:</strong>
          <span *ngFor="let r of coin.ruler; let last = last">{{ r.group?.name }}<span *ngIf="!last">, </span></span>
        </p>
        <p *ngIf="coin.referenceCode?.length"><strong>Referência:</strong>
          <span *ngFor="let ref of coin.referenceCode; let last = last">
            {{ ref.catalogue?.code || '' }} {{ ref.number || '' }}<span *ngIf="!last">, </span>
          </span>
        </p>
        <p *ngIf="coin.isDemonetized !== undefined"><strong>Demonetizada:</strong> {{ coin.isDemonetized ? 'Sim' : 'Não'
          }}</p>
        <p *ngIf="coin.demonetizationDate"><strong>Data demonetização:</strong> {{ coin.demonetizationDate |
          date:'yyyy-MM-dd' }}</p>
      </section>
      <!-- Especificações -->
      <section class="section">
        <h3>Especificações</h3>
        <p *ngIf="coin.weight"><strong>Peso:</strong> {{ coin.weight | number:'1.0-3' }} g</p>
        <p *ngIf="coin.size"><strong>Diâmetro:</strong> {{ coin.size }} mm</p>
        <p *ngIf="coin.thickness"><strong>Espessura:</strong> {{ coin.thickness }} mm</p>
        <p *ngIf="coin.shape"><strong>Formato:</strong> {{ coin.shape }}</p>
        <p *ngIf="coin.orientation"><strong>Orientação:</strong> {{ coin.orientation }}</p>
      </section>
      <!-- Material e fabricação -->
      <section class="section">
        <h3>Material e fabricação</h3>
        <p *ngIf="coin.composition?.text"><strong>Composição:</strong> {{ coin.composition.text }}</p>
        <p *ngIf="coin.technique?.text"><strong>Técnica:</strong> {{ coin.technique.text }}</p>
      </section>
      <!-- Marcas e relacionamentos -->
      <section class="section">
        <h3>Marcas e relacionamentos</h3>
        <div *ngIf="coin.mints?.length">
          <p><strong>Cunhagens:</strong></p>
          <ul class="no-bullets">
            <li *ngFor="let mint of coin.mints">{{ mint.name || mint }}</li>
          </ul>
        </div>
        <div *ngIf="coin.relatedTypes?.length">
          <p><strong>Tipos relacionados:</strong></p>
          <ul class="no-bullets">
            <li *ngFor="let r of coin.relatedTypes">{{ r.title || r.name || r }}</li>
          </ul>
        </div>
        <div *ngIf="coin.tags?.length">
          <p><strong>Tags:</strong></p>
          <div class="tags">
            <span class="tag" *ngFor="let t of coin.tags">{{ t }}</span>
          </div>
        </div>
        <div *ngIf="coin.coinGroup && (coin.coinGroup.length || coin.coinGroup.name)">
          <p><strong>Grupo:</strong></p>
          <div *ngIf="coin.coinGroup.length">
            <ul class="no-bullets">
              <li *ngFor="let g of coin.coinGroup">{{ g }}</li>
            </ul>
          </div>
          <div *ngIf="!coin.coinGroup.length">{{ coin.coinGroup.name || coin.coinGroup }}</div>
        </div>
      </section>
      <!-- Outros -->
      <section class="section misc">
        <h3>Outros</h3>
        <p *ngIf="coin.currencyName || coin.currency"><strong>Moeda:</strong> {{ coin.currencyName || coin.currency }}
        </p>
        <p *ngIf="coin.valueNumeric"><strong>Valor numérico:</strong> {{ coin.valueNumeric }}</p>
      </section>
      <h3>Minhas Moedas</h3>
      <table class="album-table">
        <thead>
          <tr>
            <th>Ano</th>
            <th>Condição</th>
            <th>Quantidade</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of albumCoins">
            <td data-label="Ano">{{ item.year }}</td>
            <td data-label="Condição">{{ item.condition || '—' }}</td>
            <td data-label="Quantidade">
              <span class="album-qty">{{ item.quantity }}</span>
            </td>
            <td data-label="Ações">
              <input type="number" [(ngModel)]="item.toRemove" [max]="item.quantity" min="1">
              <button class="btn-remove" (click)="removeCoins(item)">
                Remover
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>